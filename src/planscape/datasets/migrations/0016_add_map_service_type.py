# Generated by Django 4.2.19 on 2025-05-08 13:21

from django.db import migrations, models


def backfill_map_service_type(apps, schema_editor):
    """
    Backfills existing datalayers with their map service types.
    """
    DataLayer = apps.get_model("datasets", "DataLayer")

    for dl in DataLayer.objects.all():
        dl.map_service_type = "VECTORTILES" if dl.type == "VECTOR" else "COG"
        dl.save(update_fields=["map_service_type"])


class Migration(migrations.Migration):
    dependencies = [
        ("datasets", "0015_add_vector_styles"),
    ]

    operations = [
        migrations.AddField(
            model_name="datalayer",
            name="map_service_type",
            field=models.CharField(
                choices=[
                    ("VECTORTILES", "Vector Tiles"),
                    ("COG", "Cog"),
                    ("ESRI_GEOJSON", "ESRI GeoJSON"),
                    ("ESRI_VECTORTILES", "ESRI Vector Tiles"),
                    ("GEOJSON", "GeoJSON"),
                ],
                max_length=64,
                null=True,
            ),
        ),
        migrations.AlterField(
            model_name="datalayer",
            name="storage_type",
            field=models.CharField(
                choices=[
                    ("DATABASE", "Database"),
                    ("FILE_SYSTEM", "File System"),
                    ("EXTERNAL_SERVICE", "External Service"),
                ],
                default="FILE_SYSTEM",
                max_length=64,
            ),
        ),
        migrations.RunPython(backfill_map_service_type, migrations.RunPython.noop),
    ]
