<div class="account-dialog">
  <!-- Account details -->
  <ng-container *ngIf="!editingAccount && !changingPassword; else form">
    <h1>
      Welcome, {{ (user$ | async) ? displayName((user$ | async)!) : 'Guest' }}
    </h1>

    <div *ngIf="user$ | async as user">
      <h3>Account Name</h3>
      <h2>{{ displayName(user) }}</h2>

      <h3>Email</h3>
      <h2>{{ user.email }}</h2>

      <h3>Password</h3>
      <h2>••••••••••••••••••••••••••</h2>
    </div>

    <div class="button-row" *ngIf="user$ | async; else noUser">
      <button mat-raised-button color="primary" (click)="editAccount()">
        EDIT ACCOUNT
      </button>

      <button mat-raised-button color="primary" (click)="changePassword()">
        CHANGE PASSWORD
      </button>

      <button
        mat-raised-button
        color="warn"
        (click)="openDeleteAccountDialog()">
        DELETE ACCOUNT
      </button>

      <button mat-raised-button (click)="logout()">SIGN OUT</button>
    </div>
    <ng-template #noUser>
      <p class="no-user">
        Already have an account? Click
        <a routerLink="/login" (click)="close()">here</a>
        to login or
        <a routerLink="/signup" (click)="close()">create an account.</a>
      </p>
    </ng-template>
  </ng-container>

  <ng-template #form>
    <!-- Change password -->
    <ng-container *ngIf="changingPassword">
      <form [formGroup]="changePasswordForm" (ngSubmit)="savePassword()">
        <mat-form-field>
          <mat-label>Current password</mat-label>
          <input
            type="password"
            required
            formControlName="currentPassword"
            matInput />
        </mat-form-field>

        <mat-form-field>
          <mat-label>New password</mat-label>
          <input
            type="password"
            required
            formControlName="newPassword1"
            matInput />
        </mat-form-field>
        <button mat-icon-button class="help" [matMenuTriggerFor]="popoverMenu">
          <mat-icon class="material-symbols-outlined" color="primary">
            info_outline
          </mat-icon>
          <mat-menu #popoverMenu="matMenu">
            <div class="tooltip" style="padding: 1em">
              <div>
                <p>Password requirements:</p>
                <ul>
                  <li>Must be at least 8 characters.</li>
                  <li>Cannot be a password that you've used before.</li>
                  <li>Cannot be similar to your name or email address.</li>
                </ul>
              </div>
            </div>
          </mat-menu>
        </button>
        <mat-form-field>
          <mat-label>Confirm new password </mat-label>
          <input
            type="password"
            required
            formControlName="newPassword2"
            matInput />
        </mat-form-field>

        <div class="button-row">
          <button
            mat-raised-button
            color="primary"
            [disabled]="changePasswordForm.invalid || disableChangeButton"
            (click)="savePassword()">
            {{ disableEditButton ? 'SAVING...' : 'SAVE CHANGES' }}
          </button>

          <button mat-raised-button (click)="changingPassword = false">
            CANCEL
          </button>
        </div>
        <!-- Unified error output -->
        <mat-error *ngIf="changePasswordForm.errors || error">
          <p>Please correct the following errors:</p>
          <ul>
            <li *ngFor="let e of error">
              {{ e }}
            </li>
            <li
              *ngIf="
                changePasswordForm.get('newPassword1')?.hasError('minlength')
              ">
              Password must contain at least 8 characters.
            </li>
            <li *ngIf="changePasswordForm.errors?.['newPaswordsMustMatch']">
              The new passwords you entered do not match.
            </li>
            <li *ngIf="changePasswordForm.errors?.['newPasswordMustBeNew']">
              Your new password should not be the same as your current password.
            </li>
            <li *ngIf="changePasswordForm.errors?.['mustContainNumber']">
              Your new password must contain a number.
            </li>
            <li *ngIf="changePasswordForm.errors?.['mustContainUpper']">
              Your new password must contain at least one uppercase character.
            </li>
            <li *ngIf="changePasswordForm.errors?.['mustContainLower']">
              Your new password must contain at least one lowercase character.
            </li>
          </ul>
        </mat-error>
      </form>
    </ng-container>

    <!-- Edit account details -->
    <ng-container *ngIf="editingAccount">
      <form [formGroup]="editAccountForm" (ngSubmit)="saveEdits()">
        <mat-form-field>
          <mat-label>First name</mat-label>
          <input type="text" required formControlName="firstName" matInput />
        </mat-form-field>

        <mat-form-field>
          <mat-label>Last name</mat-label>
          <input type="text" required formControlName="lastName" matInput />
        </mat-form-field>

        <mat-form-field>
          <mat-label>Email</mat-label>
          <input
            type="text"
            disabled
            [value]="editAccountForm.get('email')?.value"
            matInput />
        </mat-form-field>

        <mat-form-field>
          <mat-label>Current password</mat-label>
          <input
            type="password"
            required
            formControlName="currentPassword"
            matInput />
        </mat-form-field>

        <div class="button-row">
          <button
            mat-raised-button
            color="primary"
            [disabled]="editAccountForm.invalid || disableEditButton"
            (click)="saveEdits()">
            {{ disableEditButton ? 'SAVING...' : 'SAVE CHANGES' }}
          </button>

          <button mat-raised-button (click)="editingAccount = false">
            CANCEL
          </button>
        </div>
        <mat-error>
          <p *ngIf="error">{{ error?.message }}</p>
        </mat-error>
      </form>
    </ng-container>
  </ng-template>
</div>
