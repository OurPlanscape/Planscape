<div class="account-dialog">
  <!-- Account details -->
  <ng-container *ngIf="!editingAccount && !changingPassword; else form">
    <h1>
      Welcome, {{ (user$ | async) ? displayName((user$ | async)!) : 'Guest' }}
    </h1>

    <div *ngIf="user$ | async as user">
      <h3>Account Name</h3>
      <h2>{{ displayName(user) }}</h2>

      <h3>Email</h3>
      <h2>{{ user.email }}</h2>

      <h3>Password</h3>
      <h2>••••••••••••••••••••••••••</h2>
    </div>

    <div class="button-row" *ngIf="user$ | async; else noUser">
      <button mat-raised-button color="primary" (click)="editAccount()">
        EDIT ACCOUNT
      </button>

      <button mat-raised-button color="primary" (click)="changePassword()">
        CHANGE PASSWORD
      </button>

      <button
        mat-raised-button
        color="warn"
        (click)="openDeleteAccountDialog()">
        DELETE ACCOUNT
      </button>

      <button mat-raised-button (click)="logout()">SIGN OUT</button>
    </div>
    <ng-template #noUser>
      <p class="no-user">
        Already have an account? Click
        <a routerLink="/login" (click)="close()">here</a>
        to login or
        <a routerLink="/signup" (click)="close()">create an account.</a>
      </p>
    </ng-template>
  </ng-container>

  <ng-template #form>
    <!-- Change password -->
    <ng-container *ngIf="changingPassword">
      <form [formGroup]="changePasswordForm" (ngSubmit)="savePassword()">
        <mat-form-field>
          <mat-label>Current password</mat-label>
          <input
            type="password"
            required
            formControlName="currentPassword"
            matInput />
        </mat-form-field>

        <mat-form-field>
          <mat-label>New password</mat-label>
          <input
            type="password"
            required
            formControlName="newPassword1"
            matInput />
        </mat-form-field>

        <mat-form-field>
          <mat-label>Confirm new password</mat-label>
          <input
            type="password"
            required
            formControlName="newPassword2"
            matInput />
        </mat-form-field>

        <div class="button-row">
          <button
            mat-raised-button
            color="primary"
            [disabled]="changePasswordForm.invalid || disableChangeButton"
            (click)="savePassword()">
            {{ disableEditButton ? 'SAVING...' : 'SAVE CHANGES' }}
          </button>

          <button mat-raised-button (click)="changingPassword = false">
            CANCEL
          </button>
        </div>

        <div #policyBox id="policyBox">
          <div *ngFor="let e of error">
            <div
              *ngIf="changePasswordForm.status === 'INVALID'"
              class="validation-error">
              <mat-icon class="warning-icon">warning</mat-icon> `{{ e }}
            </div>
          </div>
          <div
            *ngIf="changePasswordForm.errors?.['newPaswordsMustMatch'] === true"
            class="validation-error">
            <mat-icon class="warning-icon">warning</mat-icon>
            Passwords must match.
          </div>
          <div
            *ngIf="
              changePasswordForm.errors?.['newPaswordsMustMatch'] === false ||
              (changePasswordForm.errors === null &&
                changePasswordForm.pristine === false)
            "
            class="validation-ok">
            <mat-icon class="done-icon pw-validation-icons">done</mat-icon>
            Passwords must match.
          </div>
          <div
            *ngIf="
              changePasswordForm.errors?.['mustNotEqualOldPassword'] === true
            "
            class="validation-error">
            <mat-icon class="warning-icon">warning</mat-icon>
            New password must be different from old password.
          </div>
          <div
            *ngIf="
              changePasswordForm.errors?.['mustNotEqualOldPassword'] ===
                false ||
              (changePasswordForm.errors === null &&
                changePasswordForm.pristine === false)
            "
            class="validation-ok">
            <mat-icon class="done-icon pw-validation-icons">done</mat-icon>
            New password must be different from old password.
          </div>
          <div
            *ngIf="changePasswordForm.errors?.['mustBe8Characters'] === true"
            class="validation-error">
            <mat-icon class="warning-icon">warning</mat-icon>
            Your password must be at least 8 characters.
          </div>
          <div
            *ngIf="
              changePasswordForm.errors?.['mustBe8Characters'] === false ||
              (changePasswordForm.errors === null &&
                changePasswordForm.pristine === false)
            "
            class="validation-error">
            <mat-icon class="done-icon pw-validation-icons">done</mat-icon>
            Your password must be at least 8 characters.
          </div>
        </div>
      </form>
    </ng-container>

    <!-- Edit account details -->
    <ng-container *ngIf="editingAccount">
      <form [formGroup]="editAccountForm" (ngSubmit)="saveEdits()">
        <mat-form-field>
          <mat-label>First name</mat-label>
          <input type="text" required formControlName="firstName" matInput />
        </mat-form-field>

        <mat-form-field>
          <mat-label>Last name</mat-label>
          <input type="text" required formControlName="lastName" matInput />
        </mat-form-field>

        <mat-form-field>
          <mat-label>Email</mat-label>
          <input
            type="text"
            disabled
            [value]="editAccountForm.get('email')?.value"
            matInput />
        </mat-form-field>

        <mat-form-field>
          <mat-label>Current password</mat-label>
          <input
            type="password"
            required
            formControlName="currentPassword"
            matInput />
        </mat-form-field>

        <div class="button-row">
          <button
            mat-raised-button
            color="primary"
            [disabled]="editAccountForm.invalid || disableEditButton"
            (click)="saveEdits()">
            {{ disableEditButton ? 'SAVING...' : 'SAVE CHANGES' }}
          </button>

          <button mat-raised-button (click)="editingAccount = false">
            CANCEL
          </button>
        </div>
        <mat-error>
          <p *ngIf="error">{{ error?.message }}</p>
        </mat-error>
      </form>
    </ng-container>
  </ng-template>
</div>
