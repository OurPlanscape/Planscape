<app-form-message
  [messageType]="FormMessageType.SUCCESS"
  *ngIf="success"
  title="Success!"
  message="Password updated">
</app-form-message>
<h4 class="form-field-title">Password</h4>
<app-form-message
  [messageType]="FormMessageType.ERROR"
  *ngIf="error"
  title="Error!"
  message="{{ error }}">
</app-form-message>

<form
  [formGroup]="form"
  (ngSubmit)="saveForm()"
  class="credentials-form"
  *ngIf="state === 'editing' || state === 'saving'">
  <input
    type="text"
    name="username"
    autocomplete="username"
    readonly="readonly"
    [value]="username$ | async"
    class="hidden"
    required />
  <mat-label class="standard-label"
    >Current Password
    <span class="required-blurb">required</span>
  </mat-label>
  <mat-form-field appearance="outline" subscriptSizing="dynamic">
    <input
      type="password"
      required
      formControlName="current"
      matInput
      autocomplete="current-password"
      [errorStateMatcher]="currentPasswordStateMatcher" />
    <mat-error
      *ngIf="form.get('current')?.touched && form.get('current')?.invalid">
      Current password is required.
    </mat-error>
  </mat-form-field>

  <mat-label class="standard-label"
    >New Password
    <span class="required-blurb">required</span>
  </mat-label>
  <mat-form-field appearance="outline" subscriptSizing="dynamic">
    <input
      type="password"
      required
      name="new-password"
      formControlName="newPassword"
      matInput
      autocomplete="new-password"
      [errorStateMatcher]="passwordStateMatcher" />
    <mat-hint>
      Your new password needs to be at least 8 characters long and must not have
      been previously used.
    </mat-hint>
    <mat-error
      *ngIf="
        form.get('newPassword')?.touched && form.get('newPassword')?.invalid
      ">
      @if (form.get('newPassword')?.hasError('required')) {
        Password is required.
      } @else if (
        form.get('newPassword')?.hasError('minlength') ||
        form.get('newPassword')?.hasError('newPasswordMustBeNew')
      ) {
        It needs to be at least {{ MIN_PASSWORD_LENGTH }} characters long and
        different from your current password
      }
    </mat-error>
  </mat-form-field>
  <mat-label class="standard-label"
    >Confirm Password
    <span class="required-blurb">required</span>
  </mat-label>
  <mat-form-field appearance="outline" subscriptSizing="dynamic">
    <input
      type="password"
      name="confirm-password"
      required
      formControlName="passwordConfirm"
      matInput
      autocomplete="new-password"
      [errorStateMatcher]="confirmPasswordStateMatcher" />
    <mat-error
      *ngIf="
        form.get('passwordConfirm')?.touched &&
        form.get('passwordConfirm')?.invalid
      ">
      Password is required.
    </mat-error>
  </mat-form-field>
  <app-form-message
    [messageType]="FormMessageType.ERROR"
    *ngIf="form.errors?.['newPasswordsMustMatch']"
    title="Password Error"
    message="Both entries need to match"></app-form-message>
  <div class="buttons-row">
    <button
      mat-flat-button
      color="primary"
      [disabled]="state === 'saving' || form.invalid">
      SAVE
    </button>
    <button
      type="button"
      mat-stroked-button
      color="secondary"
      (click)="cancel()"
      class="btn-spaced">
      Cancel
    </button>
  </div>
</form>

<div *ngIf="state === 'view'">
  <p class="form-field-p">Change Password</p>
  <button mat-flat-button color="primary" (click)="edit()">CHANGE</button>
</div>
